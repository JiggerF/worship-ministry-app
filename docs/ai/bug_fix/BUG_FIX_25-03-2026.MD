# Bug Fixes — 25 Mar 2026

**Branch:** `fix-download-charts`

---

## Fix 1: Download All Chord Charts [PDF] button (SundayCard)

**Symptom:** The "Download All Chord Charts [PDF]" button in the portal roster's `SundayCard` was a UI stub with no `onClick` handler — clicking it did nothing.

**Root cause:** Button existed in `src/components/sunday-card.tsx` (lines 299-324) but was never wired up to any logic.

**Fix (src/components/sunday-card.tsx):**
- Added `handleDownloadAll` async handler that:
  1. Filters setlist to songs with downloadable chord charts (`file_url` present)
  2. For each song, picks the chart matching `chosen_key` (falls back to first chart with file_url if no match)
  3. Fetches all chord sheet texts in parallel via `/api/chord-sheet`
  4. Transposes each song to its `chosen_key` using `parseChordSheet` + `semitonesBetween`
  5. Compiles a single multi-page PDF with `jsPDF` — one page per song, sorted by setlist position
  6. Saves as `Chord-Charts-{date}.pdf`
- Button is **disabled** when no songs have downloadable charts (all `file_url` null/missing)
- Button is **hidden** when setlist is empty (existing behavior preserved)
- Shows **loading spinner + "Generating PDF..."** text while fetching/generating
- Added `disabled:opacity-40 disabled:cursor-not-allowed` styling per CLAUDE.md button conventions

**New imports added:**
- `useCallback`, `useMemo` from React
- `jsPDF` from `jspdf`
- `normalizeKey`, `semitonesBetween`, `parseChordSheet` from `@/lib/utils/transpose`

**Tests added (__tests__/components/sunday-card.test.tsx):**
10 new tests in "Download All Chord Charts" describe block:
1. Button disabled when no songs have downloadable charts
2. Button enabled when at least one song has a downloadable chart
3. Button enabled with partial downloadable songs
4. Clicking download fetches chord sheets and generates a PDF (correct filename)
5. Fetches the chart matching `chosen_key` when available
6. Falls back to first chart when `chosen_key` doesn't match any chart
7. Skips songs without downloadable files
8. Adds new pages for each song in the compiled PDF
9. Shows loading state while generating
10. Does not generate PDF when all fetches fail

**jsPDF mock pattern (for future reference):**
```typescript
// Must use `function` keyword (not arrow) for `new` to work in vitest 4.x
vi.mock("jspdf", () => ({
  default: vi.fn(function (this: Record<string, unknown>) {
    this.save = mockSave;
    this.addPage = mockAddPage;
    // ... etc
    this.internal = { pageSize: { getWidth: () => 595, getHeight: () => 842 } };
  }),
}));
```

---

## Audit Log Fixes

> All three fixes below relate to audit log events not being captured. Grouped here for easy reference.

---

### Fix 2: Audit log not capturing song events (BROKEN TWICE)

**Symptom:** Admin modifies a song, navigates to `/admin/audit`, sees "No activity recorded yet." — no audit entries written.

**Root cause (two bugs):**

### Bug 2a: Dev mode `actor_id: "dev"` causes FK constraint violation

**File:** `src/lib/server/get-actor.ts`

The dev auth bypass returned `{ id: "dev", name: "Dev Admin", role: "Admin" }`. When `createAuditLogEntry` tried to insert `actor_id: "dev"` into the `audit_log` table, the column is `uuid REFERENCES members(id)` — `"dev"` is not a valid UUID. Postgres rejected the insert. The error was silently swallowed by `createAuditLogEntry`'s catch block (by design — audit must never break primary ops). Result: zero audit entries written in dev mode.

**Fix:**
- Changed dev bypass to return `{ id: null, ... }` instead of `{ id: "dev", ... }` (the DB column allows NULL via `ON DELETE SET NULL`)
- Updated `AuditActor.id` type from `string` to `string | null`
- Updated `CreateAuditLogEntry.actor_id` type from `string` to `string | null`

**Files changed:**
- `src/lib/server/get-actor.ts` — `id: "dev"` → `id: null`, type `string` → `string | null`
- `src/lib/db/audit-log.ts` — `actor_id: string` → `actor_id: string | null`
- `__tests__/unit/get-actor.test.ts` — updated assertion `toBe("dev")` → `toBeNull()`

### Bug 2b: Status `"in_review"` mapping causes song PATCH to fail

**File:** `src/app/admin/songs/page.tsx`

The edit form maps `internal_approved` → `in_review` for UI display (line 376). But when saving, it sent `status: "in_review"` to the API. The DB constraint only accepts `learning | internal_approved | published` (migration `005_song_status.sql`). Result: the PATCH failed with a constraint violation, the song was NOT modified, and the audit code was never reached.

This affects ALL songs with `internal_approved` status — even if the admin only changes the title, the form always sends the current status value, which was the invalid `"in_review"`.

**Fix:**
- Added status normalization in `saveSong()` that maps `"in_review"` back to `"internal_approved"` before sending to the API

```typescript
const normalizedFields = {
  ...songFields,
  ...(songFields.status === ("in_review" as string)
    ? { status: "internal_approved" as const }
    : {}),
};
```

---

### Fix 3: Audit log not capturing setlist events

**Symptom:** Admin publishes, reverts, or modifies a setlist — no entries appear in `/admin/audit`.

**Root cause:** The four setlist API routes were never wired up to call `createAuditLogEntry`. The audit instrumentation existed for songs and roster routes, but setlist was added after and missed entirely.

**Files changed:**

#### `src/lib/types/database.ts`
Added 4 new values to the `AuditAction` union type:
```typescript
| "update_setlist"       // POST /api/setlist (upsert song into slot)
| "delete_setlist_song"  // DELETE /api/setlist/[id]
| "publish_setlist"      // PATCH /api/setlist/[date]/publish
| "revert_setlist"       // PATCH /api/setlist/[date]/revert
```

#### `src/lib/db/audit-log.ts`
Expanded `entity_type` in `CreateAuditLogEntry`:
```typescript
// Before
entity_type: "song" | "roster";
// After
entity_type: "song" | "roster" | "setlist";
```

#### `src/app/api/setlist/route.ts` (POST)
```typescript
await createAuditLogEntry({
  actor_id: actor.id ?? null,
  action: "update_setlist",
  entity_type: "setlist",
  entity_id: sunday_date,
  summary: `Updated setlist for ${sunday_date} (position ${position})`,
});
```
Also fixed a latent TypeScript error: `UUID_RE.test(actor.id)` → `UUID_RE.test(actor.id ?? "")` since `actor.id` is `string | null` after the Fix 2a change.

#### `src/app/api/setlist/[id]/route.ts` (DELETE)
```typescript
await createAuditLogEntry({
  action: "delete_setlist_song",
  entity_type: "setlist",
  entity_id: id,
  summary: `Removed song from setlist (row ${id})`,
});
```

#### `src/app/api/setlist/[id]/publish/route.ts` (PATCH)
```typescript
await createAuditLogEntry({
  action: "publish_setlist",
  entity_type: "setlist",
  entity_id: date,
  summary: `Published setlist for ${date}`,
});
```

#### `src/app/api/setlist/[id]/revert/route.ts` (PATCH)
```typescript
await createAuditLogEntry({
  action: "revert_setlist",
  entity_type: "setlist",
  entity_id: date,
  summary: `Reverted setlist to draft for ${date}`,
});
```

#### `src/app/admin/audit/page.tsx`
Added all 4 new actions to `ACTION_LABELS` and `ACTION_COLORS` so they display with labels and colour-coding in the audit UI:
```typescript
update_setlist:      "Updated setlist"           // amber
delete_setlist_song: "Removed song from setlist"  // red
publish_setlist:     "Published setlist"          // purple
revert_setlist:      "Reverted setlist to draft"  // orange
```

**Pattern note:** All 4 routes follow the same fire-and-forget pattern as songs/roster — the `createAuditLogEntry` call is wrapped in its own `try/catch` so a logging failure can never break the primary setlist operation.

**Tests added (`__tests__/integration/setlist-route-audit.test.ts`) — 20 new tests:**
- `POST /api/setlist` — correct args, summary contains date, no-op on null actor, no-op on DB throw, no-op on 400
- `DELETE /api/setlist/[id]` — correct args, summary contains row id, no-op on null actor, no-op on DB throw
- `PATCH .../publish` — correct args, summary contains date, no-op on null actor, no-op on DB throw, no-op on 400
- `PATCH .../revert` — correct args, summary contains date, no-op on null actor, no-op on DB throw, no-op on 400

---

## Test coverage status (audit log)

**What IS tested:**
- `__tests__/unit/audit-log.test.ts` — 19 tests: insert, silent error swallowing, pagination, sort, missing env vars
- `__tests__/unit/get-actor.test.ts` — tests: dev bypass, null paths, JWT parsing, member lookup, missing env vars
- `__tests__/integration/audit-log-route.test.ts` — 16 tests: GET access control (Admin/Coordinator/Musician/null), query params, errors
- `__tests__/integration/songs-route-audit.test.ts` — 14 tests: audit calls for POST/PATCH/DELETE songs
- `__tests__/integration/roster-route-audit.test.ts` — 20 tests: audit calls for roster mutations
- `__tests__/integration/setlist-route-audit.test.ts` — **20 tests (new):** audit calls for POST/DELETE/publish/revert setlist
- `__tests__/components/audit-page.test.tsx` — 22 tests: UI rendering, pagination, sort, empty/error states

**What is NOT tested (known gaps):**
1. **Dev actor_id is a valid UUID (or null)** — the test checked `id === "dev"` but never verified it wouldn't break the DB insert. Need a test that `actor_id` from dev bypass is either `null` or a valid UUID format.
2. **Status normalization on save** — no test verifies that `saveSong()` maps `"in_review"` → `"internal_approved"` before sending to API.
3. **End-to-end audit flow** — no test exercises the full chain: mutation API call → `getActorFromRequest` → `createAuditLogEntry` → entry appears in `getAuditLog()` results. The existing tests mock each layer in isolation.

**Recommendation for next session:** Add regression tests for:
- Dev bypass actor_id is null (not a non-UUID string) — `get-actor.test.ts`
- Status normalization in songs page `saveSong` — songs page test
- Full-chain integration test: call songs PATCH with dev_auth cookie → verify audit entry was written with correct action/summary

---

## All files changed this session

| File | Change | Fix |
|------|--------|-----|
| `src/components/sunday-card.tsx` | Download all chord charts PDF handler + button wiring | Fix 1 |
| `__tests__/components/sunday-card.test.tsx` | +10 download tests + jsPDF mock | Fix 1 |
| `src/lib/server/get-actor.ts` | Dev bypass `id: null`, type `string \| null` | Fix 2a |
| `src/lib/db/audit-log.ts` | `actor_id: string \| null`; `entity_type` + `"setlist"` | Fix 2a / Fix 3 |
| `src/app/admin/songs/page.tsx` | Status `"in_review"` → `"internal_approved"` normalization | Fix 2b |
| `__tests__/unit/get-actor.test.ts` | Updated dev bypass assertion | Fix 2a |
| `src/lib/types/database.ts` | Added 4 `AuditAction` values for setlist | Fix 3 |
| `src/app/api/setlist/route.ts` | Wired `createAuditLogEntry` (POST); fixed null UUID check | Fix 3 |
| `src/app/api/setlist/[id]/route.ts` | Wired `createAuditLogEntry` (DELETE) | Fix 3 |
| `src/app/api/setlist/[id]/publish/route.ts` | Wired `createAuditLogEntry` (PATCH publish) | Fix 3 |
| `src/app/api/setlist/[id]/revert/route.ts` | Wired `createAuditLogEntry` (PATCH revert) | Fix 3 |
| `src/app/admin/audit/page.tsx` | Added 4 setlist actions to `ACTION_LABELS` + `ACTION_COLORS` | Fix 3 |
| `__tests__/integration/setlist-route-audit.test.ts` | New file — 20 setlist audit instrumentation tests | Fix 3 |

**Test results:** 550 tests passing across 28 test files, 0 failures. TypeScript: clean (`tsc --noEmit`).
